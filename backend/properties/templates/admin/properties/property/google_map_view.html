{% extends "admin/base_site.html" %}
{% load i18n static humanize %}

{% block extrastyle %}
{{ block.super }}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<style>
    #map {
        width: 100%;
        height: 700px;
        margin-top: 20px;
    }

    .property-list {
        height: 600px;
        overflow-y: auto;
        margin-top: 20px;
    }

    .property-item {
        padding: 10px;
        border-bottom: 1px solid #e5e5e5;
        cursor: pointer;
    }

    .property-item:hover {
        background-color: #f5f5f5;
    }

    .property-item.active {
        background-color: #e8f0fe;
        border-left: 3px solid #1a73e8;
    }

    .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #e5e5e5;
        background-color: #f9f9f9;
        border-radius: 4px;
    }

    .filter-title {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .filter-field {
        margin-right: 15px;
        margin-bottom: 10px;
    }

    .filter-field label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .filter-actions {
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="module">
    <div class="filter-section">
        <h3 class="filter-title">Filter Properties</h3>
        <form method="get" id="filter-form">
            <div class="filter-row">
                <div class="filter-field">
                    <label for="status">Status:</label>
                    <select name="status" id="status">
                        <option value="">All</option>
                        <option value="Available" {% if filters.status=='Available' %}selected{% endif %}>Available
                        </option>
                        <option value="Pending" {% if filters.status=='Pending' %}selected{% endif %}>Pending</option>
                        <option value="Sold" {% if filters.status=='Sold' %}selected{% endif %}>Sold</option>
                        <option value="Off Market" {% if filters.status=='Off Market' %}selected{% endif %}>Off Market
                        </option>
                    </select>
                </div>
                <div class="filter-field">
                    <label for="listing_type">Listing Type:</label>
                    <select name="listing_type" id="listing_type">
                        <option value="">All</option>
                        <option value="For Sale" {% if filters.listing_type=='For Sale' %}selected{% endif %}>For Sale
                        </option>
                        <option value="For Rent" {% if filters.listing_type=='For Rent' %}selected{% endif %}>For Rent
                        </option>
                        <option value="Both" {% if filters.listing_type=='Both' %}selected{% endif %}>Both</option>
                    </select>
                </div>
                <div class="filter-field">
                    <label for="min_price">Min Price:</label>
                    <input type="number" name="min_price" id="min_price" value="{{ filters.min_price }}">
                </div>
                <div class="filter-field">
                    <label for="max_price">Max Price:</label>
                    <input type="number" name="max_price" id="max_price" value="{{ filters.max_price }}">
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-field">
                    <label for="min_bedrooms">Min Bedrooms:</label>
                    <input type="number" name="min_bedrooms" id="min_bedrooms" value="{{ filters.min_bedrooms }}">
                </div>
                <div class="filter-field">
                    <label for="min_bathrooms">Min Bathrooms:</label>
                    <input type="number" name="min_bathrooms" id="min_bathrooms" value="{{ filters.min_bathrooms }}">
                </div>
                <div class="filter-field">
                    <label for="city">City:</label>
                    <input type="text" name="city" id="city" value="{{ filters.city }}">
                </div>
                <div class="filter-field">
                    <label for="state">State:</label>
                    <input type="text" name="state" id="state" value="{{ filters.state }}">
                </div>
            </div>
            <div class="filter-actions">
                <button type="submit" class="button default">Apply Filters</button>
                <button type="button" class="button" onclick="clearFilters()">Clear Filters</button>
            </div>
        </form>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div id="map"></div>
        </div>
        <div class="col-md-4">
            <div id="property-list" class="property-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
    // Initialize the map when the page loads
    window.onload = function () {
        try {
            if (!("{{ mapbox_access_token|default:'' }}")) {
                const mapDiv = document.getElementById('map');
                mapDiv.innerHTML = '<div style="padding: 20px; text-align: center; background-color: #fff3cd; color: #664d03;">Missing MAPBOX_ACCESS_TOKEN</div>';
                return;
            }
            mapboxgl.accessToken = '{{ mapbox_access_token|default:"" }}';
            const styleUrl = '{{ mapbox_style|default:"mapbox://styles/mapbox/streets-v12" }}';

            const map = new mapboxgl.Map({
                container: 'map',
                style: styleUrl,
                center: [-98.5795, 39.8283],
                zoom: 4
            });

            const properties = JSON.parse('{{ properties_json|escapejs }}');
            const markersById = {};
            const bounds = new mapboxgl.LngLatBounds();
            let count = 0;

            properties.forEach(p => {
                if (p.latitude && p.longitude) {
                    const marker = new mapboxgl.Marker()
                        .setLngLat([p.longitude, p.latitude])
                        .setPopup(new mapboxgl.Popup({ offset: 16 }).setHTML(`
                            <div>
                                <h3>${p.title}</h3>
                                <p>${p.address_line1}, ${p.city}, ${p.state}</p>
                                <p>${p.bedrooms} bd | ${p.bathrooms} ba | ${p.square_feet} sqft</p>
                                <p><strong>$${Number(p.price).toLocaleString()}</strong></p>
                                <p>Status: ${p.status}</p>
                                <p>Listing Type: ${p.listing_type}</p>
                                <p><a href="/admin/properties/property/${p.id}/change/" target="_blank">Edit Property</a></p>
                            </div>
                        `))
                        .addTo(map);
                    markersById[p.id] = marker;
                    bounds.extend([p.longitude, p.latitude]);
                    count++;
                }
            });

            if (count) {
                map.fitBounds(bounds, { padding: 40, maxZoom: 14 });
            }

            // Populate property list and attach click handlers
            const propertyList = document.getElementById('property-list');
            properties.forEach(p => {
                if (p.latitude && p.longitude) {
                    const propertyItem = document.createElement('div');
                    propertyItem.className = 'property-item';
                    propertyItem.id = `property-${p.id}`;
                    propertyItem.innerHTML = `
                        <h4>${p.title}</h4>
                        <p>${p.address_line1}, ${p.city}, ${p.state}</p>
                        <p><strong>$${Number(p.price).toLocaleString()}</strong></p>
                        <p>${p.bedrooms} bd | ${p.bathrooms} ba | ${p.square_feet} sqft</p>
                        <p>Status: ${p.status}</p>
                    `;
                    propertyItem.addEventListener('click', () => {
                        const marker = markersById[p.id];
                        if (marker) {
                            const ll = marker.getLngLat();
                            map.flyTo({ center: ll, zoom: 15 });
                            marker.togglePopup();
                            highlightProperty(p.id);
                        }
                    });
                    propertyList.appendChild(propertyItem);
                }
            });

            function highlightProperty(id) {
                document.querySelectorAll('.property-item').forEach(item => item.classList.remove('active'));
                const el = document.getElementById(`property-${id}`);
                if (el) {
                    el.classList.add('active');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        } catch (e) {
            const mapDiv = document.getElementById('map');
            if (mapDiv) {
                mapDiv.innerHTML = `<div style="padding: 20px; text-align: center; background-color: #ffeeee; color: #cc0000;">
                    <h3>Error Loading Map</h3>
                    <p>${e.message}</p>
                </div>`;
            }
            console.error(e);
        }
    };

    function clearFilters() {
        document.getElementById("status").value = "";
        document.getElementById("listing_type").value = "";
        document.getElementById("min_price").value = "";
        document.getElementById("max_price").value = "";
        document.getElementById("min_bedrooms").value = "";
        document.getElementById("min_bathrooms").value = "";
        document.getElementById("city").value = "";
        document.getElementById("state").value = "";
        document.getElementById("filter-form").submit();
    }
</script>
{% endblock %}