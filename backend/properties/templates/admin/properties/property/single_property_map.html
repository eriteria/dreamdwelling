{% extends "admin/base_site.html" %}
{% load i18n static humanize %}

{% block extrastyle %}
{{ block.super }}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<style>
    #map {
        width: 100%;
        height: 600px;
        margin-top: 20px;
    }

    .property-details {
        margin-top: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
    }

    .property-details h2 {
        margin-top: 0;
    }

    .property-details dl {
        display: grid;
        grid-template-columns: max-content auto;
        grid-gap: 0.5em 1em;
    }

    .property-details dt {
        font-weight: bold;
        text-align: right;
    }

    .property-details dd {
        margin: 0;
    }

    .back-button {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ property.title }}</h1>

<div class="row">
    <div class="col-md-8">
        <div id="map"></div>
    </div>
    <div class="col-md-4">
        <div class="property-details">
            <h2>Property Details</h2>
            <dl>
                <dt>Address:</dt>
                <dd>{{ property.address_line1 }}, {{ property.city }}, {{ property.state }} {{ property.zipcode }}</dd>

                <dt>Price:</dt>
                <dd>${{ property.price|intcomma }}</dd>

                <dt>Status:</dt>
                <dd>{{ property.status }}</dd>

                <dt>Listing Type:</dt>
                <dd>{{ property.listing_type }}</dd>

                <dt>Bedrooms:</dt>
                <dd>{{ property.bedrooms }}</dd>

                <dt>Bathrooms:</dt>
                <dd>{{ property.bathrooms }}</dd>

                <dt>Square Feet:</dt>
                <dd>{{ property.square_feet|intcomma }}</dd>

                <dt>Year Built:</dt>
                <dd>{{ property.year_built }}</dd>

                <dt>Lot Size:</dt>
                <dd>{{ property.lot_size|default:"N/A" }}</dd>
            </dl>

            <div class="actions">
                <a href="{% url 'admin:properties_property_change' property.id %}" class="button">Edit Property</a>
            </div>
        </div>

        <div class="back-button">
            <a href="{% url 'admin:properties_property_changelist' %}" class="button">Back to Property List</a>
            <a href="{% url 'admin:property_google_map' %}" class="button">View All Properties</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
    window.onload = function () {
        if (!("{{ mapbox_access_token|default:'' }}")) {
            document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; background-color: #fff3cd; color: #664d03;">Missing MAPBOX_ACCESS_TOKEN</div>';
            return;
        }
        mapboxgl.accessToken = '{{ mapbox_access_token|default:"" }}';
        const styleUrl = '{{ mapbox_style|default:"mapbox://styles/mapbox/streets-v12" }}';
        const lat = parseFloat('{{ property.latitude|default:"0" }}');
        const lng = parseFloat('{{ property.longitude|default:"0" }}');
        const map = new mapboxgl.Map({
            container: 'map',
            style: styleUrl,
            center: [lng, lat],
            zoom: 15
        });
        const popupHtml =
            '<div>' +
            '<h3>{{ property.title|escape }}</h3>' +
            '<p>{{ property.address_line1|escape }}, {{ property.city|escape }}, {{ property.state|escape }}</p>' +
            '<p><strong>$' + new Intl.NumberFormat('en-US').format(parseFloat('{{ property.price|default:"0" }}')) + '</strong></p>' +
            '<p>{{ property.bedrooms }} bd | {{ property.bathrooms }} ba | {{ property.square_feet|intcomma }} sqft</p>' +
            '</div>';

        const marker = new mapboxgl.Marker()
            .setLngLat([lng, lat])
            .setPopup(new mapboxgl.Popup({ offset: 16 }).setHTML(popupHtml))
            .addTo(map);
        marker.togglePopup();
    };
</script>
{% endblock %}