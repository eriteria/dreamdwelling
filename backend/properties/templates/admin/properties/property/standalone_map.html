<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Property Map Test (Mapbox)</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        h1 {
            color: #417690;
            margin-bottom: 20px;
        }

        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .debug-info {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }

        .property-list {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .property-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .property-item:hover {
            background-color: #f5f5f5;
        }

        .property-item.active {
            background-color: #e8f4f8;
        }

        .property-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .property-address {
            font-size: 0.9em;
        }

        .property-details {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .property-price {
            color: #417690;
            font-weight: bold;
        }

        .warn {
            background: #fff3cd;
            color: #664d03;
            padding: 8px;
            border: 1px solid #ffe69c;
        }
    </style>
</head>

<body>
    <h1>Property Map Test (Mapbox)</h1>
    <div style="display: flex; flex-wrap: wrap;">
        <div style="flex: 3; min-width: 300px; padding-right: 20px;">
            <div id="map"></div>
            <div class="debug-info">
                <h3>Debug Info</h3>
                <div id="debug"></div>
            </div>
        </div>
        <div style="flex: 1; min-width: 250px;">
            <h2>Properties</h2>
            <div id="property-list" class="property-list"></div>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        function log(message) {
            console.log(message);
            const debug = document.getElementById('debug');
            if (debug) debug.innerHTML += '<p>' + message + '</p>';
        }

        document.addEventListener('DOMContentLoaded', function () {
            try {
                log('Initializing map...');

                const token = '{{ mapbox_access_token|default:"" }}';
                const styleUrl = '{{ mapbox_style|default:"mapbox://styles/mapbox/streets-v12" }}';
                if (!token) {
                    document.getElementById('map').innerHTML = '<div class="warn">Missing MAPBOX_ACCESS_TOKEN</div>';
                    log('Missing token');
                    return;
                }

                mapboxgl.accessToken = token;
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: styleUrl,
                    center: [-98.5795, 39.8283],
                    zoom: 4,
                });
                map.addControl(new mapboxgl.NavigationControl());
                log('Map initialized');

                // Small sample dataset (kept minimal for this standalone demo)
                const propertiesData = [
                    { id: 1, title: 'Modern Condo in Chicago', address_line1: '123 Lakeshore Dr', city: 'Chicago', state: 'IL', latitude: 41.8781, longitude: -87.6298, price: 550000, bedrooms: 2, bathrooms: 2, square_feet: 1200 },
                    { id: 2, title: 'Charming Home in Austin', address_line1: '456 Barton Springs', city: 'Austin', state: 'TX', latitude: 30.2672, longitude: -97.7431, price: 425000, bedrooms: 3, bathrooms: 2, square_feet: 1500 },
                    { id: 3, title: 'Townhouse in Atlanta', address_line1: '789 Peachtree St', city: 'Atlanta', state: 'GA', latitude: 33.7490, longitude: -84.3880, price: 375000, bedrooms: 3, bathrooms: 2.5, square_feet: 1600 },
                    { id: 4, title: 'Loft in New York', address_line1: '101 Broadway', city: 'New York', state: 'NY', latitude: 40.7128, longitude: -74.0060, price: 875000, bedrooms: 1, bathrooms: 1, square_feet: 800 },
                    { id: 5, title: 'Bungalow in Denver', address_line1: '202 Colfax Ave', city: 'Denver', state: 'CO', latitude: 39.7392, longitude: -104.9903, price: 510000, bedrooms: 2, bathrooms: 1.5, square_feet: 1100 },
                ];

                log('Loaded ' + propertiesData.length + ' properties');

                const markers = {};
                const bounds = new mapboxgl.LngLatBounds();
                let hasValidProperties = false;
                const propertyListElement = document.getElementById('property-list');

                propertiesData.forEach((property) => {
                    try {
                        if (property.latitude && property.longitude) {
                            hasValidProperties = true;
                            const marker = new mapboxgl.Marker()
                                .setLngLat([property.longitude, property.latitude])
                                .setPopup(
                                    new mapboxgl.Popup().setHTML(
                                        '<strong>' + property.title + '</strong><br>' +
                                        property.address_line1 + ', ' + property.city + ', ' + property.state + '<br>' +
                                        property.bedrooms + ' bd | ' + property.bathrooms + ' ba | ' + property.square_feet + ' sqft<br>' +
                                        '<strong>$' + property.price.toLocaleString() + '</strong>'
                                    )
                                )
                                .addTo(map);

                            marker.propertyId = property.id;
                            markers[property.id] = marker;
                            bounds.extend([property.longitude, property.latitude]);

                            marker.getElement().addEventListener('click', function () {
                                highlightProperty(property.id);
                            });

                            const listItem = document.createElement('div');
                            listItem.className = 'property-item';
                            listItem.dataset.id = property.id;
                            listItem.innerHTML = `
                                <div class="property-title">${property.title}</div>
                                <div class="property-address">${property.address_line1}, ${property.city}, ${property.state}</div>
                                <div class="property-details">
                                    <span>${property.bedrooms} bd | ${property.bathrooms} ba | ${property.square_feet} sqft</span>
                                    <span class="property-price">$${property.price.toLocaleString()}</span>
                                </div>
                            `;

                            listItem.addEventListener('click', function () {
                                const id = parseInt(this.dataset.id);
                                const marker = markers[id];
                                if (marker) {
                                    const lngLat = marker.getLngLat();
                                    map.flyTo({ center: [lngLat.lng, lngLat.lat], zoom: 14 });
                                    marker.togglePopup();
                                    highlightProperty(id);
                                }
                            });

                            propertyListElement.appendChild(listItem);
                        }
                    } catch (e) {
                        log('Error adding property ' + property.id + ': ' + e.message);
                    }
                });

                function highlightProperty(propertyId) {
                    document.querySelectorAll('.property-item').forEach(function (item) {
                        item.classList.remove('active');
                        if (parseInt(item.dataset.id) === propertyId) {
                            item.classList.add('active');
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                }

                if (hasValidProperties) {
                    map.fitBounds(bounds, { padding: 40 });
                    log('Map bounds adjusted to show all properties');
                } else {
                    log('No valid properties with coordinates found');
                }

                log('Map setup complete');
            } catch (e) {
                log('ERROR: ' + e.message);
                console.error(e);
            }
        });
    </script>
</body>

</html>