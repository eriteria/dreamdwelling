{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    #map {
        width: 100%;
        height: 500px;
    }

    #debug {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
    }

    .test-map {
        height: 300px;
        margin: 15px 0;
        border: 1px solid #ccc;
    }

    .resource-status {
        padding: 5px;
        border-radius: 4px;
        margin: 5px 0;
    }

    .status-success {
        background-color: #d4edda;
        color: #155724;
    }

    .status-error {
        background-color: #f8d7da;
        color: #721c24;
    }

    #debug-log {
        max-height: 200px;
        overflow-y: auto;
        background-color: #272822;
        color: #f8f8f2;
        padding: 10px;
        font-family: monospace;
        border-radius: 4px;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Map Debug Page</h1>

    <div id="resource-status" class="module">
        <h2>Resource Status</h2>
        <div id="mapbox-status" class="resource-status">Checking Mapbox...</div>
    </div>

    <div class="module">
        <h2>Mapbox Test</h2>
        <div id="mapbox-map" class="test-map"></div>
    </div>

    <div class="module">
        <h2>Debug Log</h2>
        <div id="debug-log"></div>
    </div>
</div>

<script>
    // Utility functions
    function log(message, type = 'info') {
        const logDiv = document.getElementById('debug-log');
        const now = new Date();
        const timestamp = now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');
        const entry = document.createElement('div');
        entry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;

        if (type === 'error') {
            entry.style.color = '#ff6b6b';
        } else if (type === 'success') {
            entry.style.color = '#69db7c';
        }

        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(`[${type}] ${message}`);
    }

    function updateStatus(id, loaded, version = null) {
        const element = document.getElementById(id);
        if (loaded) {
            element.innerHTML = `✅ ${id.split('-')[0].toUpperCase()} loaded${version ? ` (v${version})` : ''}`;
            element.className = 'resource-status status-success';
        } else {
            element.innerHTML = `❌ ${id.split('-')[0].toUpperCase()} not loaded`;
            element.className = 'resource-status status-error';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        log('Starting map resource tests...');
        // Check Mapbox
        if (typeof mapboxgl !== 'undefined') {
            updateStatus('mapbox-status', true, mapboxgl.version);
            log('Mapbox GL loaded successfully', 'success');
            initMapboxMap();
        } else {
            updateStatus('mapbox-status', false);
            log('Mapbox GL failed to load', 'error');
        }

        function initMapboxMap() {
            try {
                if (!("{{ mapbox_access_token|default:'' }}")) {
                    log('Missing MAPBOX_ACCESS_TOKEN in backend', 'error');
                    document.getElementById('mapbox-map').innerHTML = '<div style="padding: 10px; background:#fff3cd; color:#664d03;">Missing MAPBOX_ACCESS_TOKEN</div>';
                    return;
                }
                mapboxgl.accessToken = '{{ mapbox_access_token|default:"" }}';
                const styleUrl = '{{ mapbox_style|default:"mapbox://styles/mapbox/streets-v12" }}';
                const map = new mapboxgl.Map({
                    container: 'mapbox-map',
                    style: styleUrl,
                    center: [-74.0060, 40.7128],
                    zoom: 12
                });
                new mapboxgl.Marker().setLngLat([-74.0060, 40.7128]).addTo(map);
                log('Mapbox map initialized successfully', 'success');
            } catch (e) {
                log(`Error initializing Mapbox map: ${e.message}`, 'error');
                console.error(e);
            }
        }
</script>
{% endblock %}