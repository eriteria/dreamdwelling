{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<!-- Load Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Load Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp" async defer></script>

<!-- Load MarkerClusterer -->
<script src="https://unpkg.com/@googlemaps/markerclusterer@2.0.8/dist/index.min.js"></script>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    #map {
        width: 100%;
        height: 500px;
    }

    #debug {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
    }

    .test-map {
        height: 300px;
        margin: 15px 0;
        border: 1px solid #ccc;
    }

    .resource-status {
        padding: 5px;
        border-radius: 4px;
        margin: 5px 0;
    }

    .status-success {
        background-color: #d4edda;
        color: #155724;
    }

    .status-error {
        background-color: #f8d7da;
        color: #721c24;
    }

    #debug-log {
        max-height: 200px;
        overflow-y: auto;
        background-color: #272822;
        color: #f8f8f2;
        padding: 10px;
        font-family: monospace;
        border-radius: 4px;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Map Debug Page</h1>

    <div id="resource-status" class="module">
        <h2>Resource Status</h2>
        <div id="leaflet-status" class="resource-status">Checking Leaflet...</div>
        <div id="google-status" class="resource-status">Checking Google Maps...</div>
        <div id="cluster-status" class="resource-status">Checking MarkerClusterer...</div>
    </div>

    <div class="module">
        <h2>Leaflet Test</h2>
        <div id="leaflet-map" class="test-map"></div>
    </div>

    <div class="module">
        <h2>Google Maps Test</h2>
        <div id="google-map" class="test-map"></div>
    </div>

    <div class="module">
        <h2>Debug Log</h2>
        <div id="debug-log"></div>
    </div>
</div>

<script>
    // Utility functions
    function log(message, type = 'info') {
        const logDiv = document.getElementById('debug-log');
        const now = new Date();
        const timestamp = now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');
        const entry = document.createElement('div');
        entry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;

        if (type === 'error') {
            entry.style.color = '#ff6b6b';
        } else if (type === 'success') {
            entry.style.color = '#69db7c';
        }

        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(`[${type}] ${message}`);
    }

    function updateStatus(id, loaded, version = null) {
        const element = document.getElementById(id);
        if (loaded) {
            element.innerHTML = `✅ ${id.split('-')[0].toUpperCase()} loaded${version ? ` (v${version})` : ''}`;
            element.className = 'resource-status status-success';
        } else {
            element.innerHTML = `❌ ${id.split('-')[0].toUpperCase()} not loaded`;
            element.className = 'resource-status status-error';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        log('Starting map resource tests...');

        // Check resources
        setTimeout(checkResources, 500);
    });

    function checkResources() {
        log('Checking map resources...');

        // Check Leaflet
        if (typeof L !== 'undefined') {
            updateStatus('leaflet-status', true, L.version);
            log('Leaflet loaded successfully', 'success');
            initLeafletMap();
        } else {
            updateStatus('leaflet-status', false);
            log('Leaflet failed to load', 'error');
        }

        // Check Google Maps
        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
            updateStatus('google-status', true);
            log('Google Maps loaded successfully', 'success');
            initGoogleMap();
        } else {
            updateStatus('google-status', false);
            log('Google Maps not loaded yet', 'info');
            log('Will retry in 2 seconds...', 'info');
            setTimeout(function () {
                if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                    updateStatus('google-status', true);
                    log('Google Maps loaded successfully on retry', 'success');
                    initGoogleMap();
                } else {
                    log('Google Maps failed to load after retry', 'error');
                }
            }, 2000);
        }

        // Check MarkerClusterer
        if (typeof MarkerClusterer !== 'undefined') {
            updateStatus('cluster-status', true);
            log('MarkerClusterer loaded successfully', 'success');
        } else {
            updateStatus('cluster-status', false);
            log('MarkerClusterer not available, will check again later', 'info');
            setTimeout(function () {
                if (typeof MarkerClusterer !== 'undefined') {
                    updateStatus('cluster-status', true);
                    log('MarkerClusterer loaded successfully on retry', 'success');
                } else {
                    log('MarkerClusterer failed to load after retry', 'error');
                }
            }, 2000);
        }
    }

    function initLeafletMap() {
        try {
            const map = L.map('leaflet-map').setView([40.7128, -74.0060], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([40.7128, -74.0060])
                .addTo(map)
                .bindPopup('Test Property<br>New York, NY')
                .openPopup();

            log('Leaflet map initialized successfully', 'success');
        } catch (e) {
            log(`Error initializing Leaflet map: ${e.message}`, 'error');
            console.error(e);
        }
    }

    function initGoogleMap() {
        try {
            const map = new google.maps.Map(document.getElementById('google-map'), {
                center: { lat: 40.7128, lng: -74.0060 },
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            const marker = new google.maps.Marker({
                position: { lat: 40.7128, lng: -74.0060 },
                map: map,
                title: 'Test Property'
            });

            const infowindow = new google.maps.InfoWindow({
                content: '<div><strong>Test Property</strong><br>New York, NY</div>'
            });

            marker.addListener('click', function () {
                infowindow.open(map, marker);
            });

            log('Google Maps initialized successfully', 'success');

            // Try to initialize clustering
            if (typeof MarkerClusterer !== 'undefined') {
                try {
                    const markers = [
                        new google.maps.Marker({
                            position: { lat: 40.7128, lng: -74.0060 },
                            title: 'Property 1'
                        }),
                        new google.maps.Marker({
                            position: { lat: 40.7228, lng: -74.0160 },
                            title: 'Property 2'
                        }),
                        new google.maps.Marker({
                            position: { lat: 40.7028, lng: -73.9960 },
                            title: 'Property 3'
                        })
                    ];

                    new MarkerClusterer({ map, markers });
                    log('MarkerClusterer initialized successfully', 'success');
                } catch (e) {
                    log(`Error initializing MarkerClusterer: ${e.message}`, 'error');
                    console.error(e);
                }
            }
        } catch (e) {
            log(`Error initializing Google Maps: ${e.message}`, 'error');
            console.error(e);
        }
    }
</script>
{% endblock %}