{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<!-- Mapbox GL JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .test-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .test-heading {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .test-map {
        height: 300px;
        margin: 15px 0;
        border: 1px solid #ccc;
    }

    .test-status {
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
    }

    .test-success {
        background-color: #d4edda;
        color: #155724;
    }

    .test-failure {
        background-color: #f8d7da;
        color: #721c24;
    }

    .test-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    #debug-log {
        max-height: 220px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        background-color: #f8f9fa;
        padding: 10px;
        border: 1px solid #ddd;
    }

    .log-entry {
        margin: 0;
        padding: 2px 0;
    }

    .log-info {
        color: #0c5460;
    }

    .log-error {
        color: #721c24;
    }

    .log-success {
        color: #155724;
    }
</style>
{% endblock %}

{% block content %}
<h1>Map Diagnostics (Mapbox)</h1>
<p>Mapbox-only diagnostics page to verify resources, token, style, network connectivity, and render.</p>

<div id="debug-log"></div>

<!-- Resource Loading Test -->
<div id="resource-test" class="test-section">
    <h2 class="test-heading">Resource Loading Test</h2>
    <div id="resource-list">
        <p>Mapbox GL JS: <span id="mapbox-js-status">Checking...</span></p>
        <p>Mapbox GL CSS: <span id="mapbox-css-status">Checking...</span></p>
        <p>Access Token: <span id="token-status">Checking...</span></p>
        <p>Style URL: <span id="style-status">Checking...</span></p>
    </div>
    <div id="resource-status" class="test-status test-pending">Checking resources...</div>
    <div class="test-status" id="config-values" style="font-family: monospace; white-space: pre-wrap;"></div>

</div>

<!-- Mapbox Render Test -->
<div id="mapbox-test" class="test-section">
    <h2 class="test-heading">Mapbox Render Test</h2>
    <div id="mapbox-map" class="test-map"></div>
    <div id="mapbox-status" class="test-status test-pending">Waiting for map...</div>
    <div id="mapbox-events" style="font-family: monospace; font-size: 12px;"></div>

</div>

<!-- Property Data Test (Mapbox format) -->
<div id="property-data-test" class="test-section">
    <h2 class="test-heading">Property Data Format Test</h2>
    <div id="property-data-display" style="font-family: monospace; white-space: pre-wrap;"></div>
    <div id="property-data-status" class="test-status test-pending">Running test...</div>
</div>

<!-- Browser Information -->
<div class="test-section">
    <h2 class="test-heading">Browser Information</h2>
    <div id="browser-info"></div>
</div>

<!-- Network Test -->
<div class="test-section">
    <h2 class="test-heading">Network Connectivity Test</h2>
    <div id="network-status" class="test-status test-pending">Running tests...</div>
</div>
{% endblock %}

{% block extrajs %}
<script>
    // Debug logging function
    function log(message, type = 'info') {
        const logDiv = document.getElementById('debug-log');
        const entry = document.createElement('p');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
        if (type === 'error') console.error(message); else console.log(message);
    }

    function updateStatus(elementId, success, message) {
        const statusDiv = document.getElementById(elementId);
        statusDiv.textContent = message;
        statusDiv.className = `test-status ${success ? 'test-success' : 'test-failure'}`;
    }

    function checkResources() {
        log('Checking Mapbox resources');
        const token = '{{ mapbox_access_token|default:"" }}';
        const styleUrl = '{{ mapbox_style|default:"mapbox://styles/mapbox/streets-v12" }}';

        // Mapbox JS
        const jsLoaded = typeof mapboxgl !== 'undefined';
        document.getElementById('mapbox-js-status').textContent = jsLoaded ? 'Loaded ✓' : 'Not loaded ✗';
        document.getElementById('mapbox-js-status').style.color = jsLoaded ? 'green' : 'red';

        // Mapbox CSS
        const cssLoaded = !!document.querySelector('link[href*="mapbox-gl.css"]');
        document.getElementById('mapbox-css-status').textContent = cssLoaded ? 'Loaded ✓' : 'Not loaded ✗';
        document.getElementById('mapbox-css-status').style.color = cssLoaded ? 'green' : 'red';

        // Token
        const hasToken = !!token;
        document.getElementById('token-status').textContent = hasToken ? 'Present ✓' : 'Missing ✗';
        document.getElementById('token-status').style.color = hasToken ? 'green' : 'red';

        // Style URL
        const hasStyle = !!styleUrl;
        document.getElementById('style-status').textContent = hasStyle ? 'Present ✓' : 'Missing ✗';
        document.getElementById('style-status').style.color = hasStyle ? 'green' : 'red';

        document.getElementById('config-values').textContent = `Token: ${hasToken ? token.slice(0, 10) + '…' : '(none)'}\nStyle: ${styleUrl}`;

        const ok = jsLoaded && cssLoaded && hasToken && hasStyle;
        updateStatus('resource-status', ok, ok ? 'All required resources are available' : 'Missing required resources');
        return { token, styleUrl };
    }

    function runMapboxRenderTest(token, styleUrl) {
        log('Starting Mapbox render test');
        if (!token) {
            updateStatus('mapbox-status', false, 'Missing Mapbox access token');
            return;
        }
        mapboxgl.accessToken = token;
        try {
            const map = new mapboxgl.Map({
                container: 'mapbox-map',
                style: styleUrl,
                center: [-98.5795, 39.8283],
                zoom: 3.8,
            });
            map.addControl(new mapboxgl.NavigationControl());

            const eventsDiv = document.getElementById('mapbox-events');
            const note = (msg) => { const p = document.createElement('div'); p.textContent = msg; eventsDiv.appendChild(p); };

            map.on('load', () => {
                log('Mapbox map loaded', 'success');
                updateStatus('mapbox-status', true, 'Map rendered successfully');

                // Add a simple marker and popup
                const marker = new mapboxgl.Marker()
                    .setLngLat([-98.5795, 39.8283])
                    .setPopup(new mapboxgl.Popup().setHTML('<strong>USA Center</strong>'))
                    .addTo(map);

                marker.getElement().addEventListener('click', () => log('Marker clicked'));

                // Add a tiny GeoJSON source/layer as a smoke test
                const geojson = {
                    type: 'FeatureCollection',
                    features: [
                        { type: 'Feature', properties: { name: 'Denver' }, geometry: { type: 'Point', coordinates: [-104.9903, 39.7392] } },
                        { type: 'Feature', properties: { name: 'Chicago' }, geometry: { type: 'Point', coordinates: [-87.6298, 41.8781] } },
                    ]
                };
                map.addSource('cities', { type: 'geojson', data: geojson });
                map.addLayer({ id: 'cities-layer', type: 'circle', source: 'cities', paint: { 'circle-radius': 6, 'circle-color': '#1d4ed8' } });
                note('Added cities layer');
            });

            map.on('error', (e) => { log('Map error: ' + (e && e.error ? e.error.message : 'unknown'), 'error'); });
            map.on('idle', () => { note('Map idle'); });
        } catch (e) {
            updateStatus('mapbox-status', false, 'Error creating map: ' + e.message);
            log('Mapbox render error: ' + e.message, 'error');
        }
    }

    function testNetworkConnectivity(token, styleUrl) {
        log('Testing network connectivity to Mapbox');
        const urls = [
            'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js',
            'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css',
        ];
        if (token) {
            // Attempt to hit a style endpoint (will likely be 200 if token is valid)
            const styleEndpoint = `https://api.mapbox.com/styles/v1/${encodeURIComponent(styleUrl.replace('mapbox://styles/', ''))}?access_token=${encodeURIComponent(token)}`;
            urls.push(styleEndpoint);
        }

        let succeeded = 0, failed = 0, total = urls.length;
        urls.forEach(url => {
            try {
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', url, true);
                xhr.onload = function () { log(`HEAD ${url} -> ${xhr.status}`, xhr.status < 400 ? 'success' : 'error'); (xhr.status < 400 ? succeeded : failed)++; checkComplete(); };
                xhr.onerror = function () { log(`HEAD ${url} -> network error`, 'error'); failed++; checkComplete(); };
                xhr.send();
            } catch (e) { log(`HEAD ${url} -> exception ${e.message}`, 'error'); failed++; checkComplete(); }
        });
        function checkComplete() {
            if (succeeded + failed === total) {
                const ok = failed === 0;
                updateStatus('network-status', ok, ok ? `All ${total} checks passed` : `${failed} of ${total} checks failed`);
            }
        }
    }

    function showBrowserInfo() {
        const el = document.getElementById('browser-info');
        const info = [
            `User Agent: ${navigator.userAgent}`,
            `Platform: ${navigator.platform}`,
            `Cookies Enabled: ${navigator.cookieEnabled}`,
            `Language: ${navigator.language}`,
            `Online: ${navigator.onLine}`,
            `Screen: ${window.screen.width} x ${window.screen.height}`,
            `Window: ${window.innerWidth} x ${window.innerHeight}`,
        ];
        el.innerHTML = info.map(i => `<p>${i}</p>`).join('');
    }

    function testPropertyData() {
        log('Testing property data formatting for Mapbox');
        try {
            const sampleProperty = {
                id: 1,
                title: 'Test Property',
                address: '123 Test Street, Testville',
                latitude: 39.8283,
                longitude: -98.5795,
                price: 350000,
                status: 'For Sale',
                property_type: 'House',
                bedrooms: 3,
                bathrooms: 2,
                square_feet: 1800,
            };

            const mapboxFeature = {
                type: 'Feature',
                properties: {
                    id: sampleProperty.id,
                    title: sampleProperty.title,
                    address: sampleProperty.address,
                    price: sampleProperty.price,
                },
                geometry: { type: 'Point', coordinates: [sampleProperty.longitude, sampleProperty.latitude] },
            };

            const dataDisplay = document.getElementById('property-data-display');
            dataDisplay.innerHTML = `
                <h3>Sample Property:</h3>
                <pre>${JSON.stringify(sampleProperty, null, 2)}</pre>
                <h3>Mapbox GeoJSON Feature:</h3>
                <pre>${JSON.stringify(mapboxFeature, null, 2)}</pre>
            `;

            updateStatus('property-data-status', true, 'Property data formatting successful');
            log('Property data formatting test complete', 'success');
        } catch (e) {
            updateStatus('property-data-status', false, `Error: ${e.message}`);
            log('Property data formatting error: ' + e.message, 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        log('Starting Mapbox diagnostics');
        showBrowserInfo();
        const { token, styleUrl } = checkResources();
        testNetworkConnectivity(token, styleUrl);
        runMapboxRenderTest(token, styleUrl);
        testPropertyData();
    });
</script>
{% endblock %}