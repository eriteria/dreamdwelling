{% extends "admin/base_site.html" %}
{% load i18n static humanize %}

{% block extrastyle %}
{{ block.super }}
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<style>
    #map {
        width: 100%;
        height: 600px;
        margin-top: 20px;
    }

    .property-list {
        height: 600px;
        overflow-y: auto;
        margin-top: 20px;
    }

    .property-item {
        padding: 10px;
        border-bottom: 1px solid #e5e5e5;
        cursor: pointer;
    }

    .property-item:hover {
        background-color: #f5f5f5;
    }

    .property-item.active {
        background-color: #e8f0fe;
        border-left: 3px solid #1a73e8;
    }

    .filter-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #e5e5e5;
        background-color: #f9f9f9;
        border-radius: 4px;
    }

    .filter-title {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }

    .filter-field {
        margin-right: 15px;
        margin-bottom: 10px;
    }

    .filter-field label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .filter-actions {
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="module">
    <div class="row">
        <div class="col-md-12">
            <div id="map"></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div id="property-list" class="property-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
    window.onload = function () {
        if (!("{{ mapbox_access_token|default:'' }}")) {
            document.getElementById('map').innerHTML = '<div style="padding: 20px; text-align: center; background-color: #fff3cd; color: #664d03;">Missing MAPBOX_ACCESS_TOKEN</div>';
            return;
        }
        mapboxgl.accessToken = '{{ mapbox_access_token|default:"" }}';
        const styleUrl = '{{ mapbox_style|default:"mapbox://styles/mapbox/streets-v12" }}';
        const map = new mapboxgl.Map({
            container: 'map',
            style: styleUrl,
            center: [-98.5795, 39.8283],
            zoom: 4
        });

        const properties = JSON.parse('{{ properties_json|escapejs }}');
        const markers = {};
        const bounds = new mapboxgl.LngLatBounds();

        properties.forEach(function (property) {
            const lng = Number(property.lng);
            const lat = Number(property.lat);
            const marker = new mapboxgl.Marker()
                .setLngLat([lng, lat])
                .setPopup(new mapboxgl.Popup({ offset: 16 }).setHTML(
                    '<div>' +
                    '<h4>' + property.title + '</h4>' +
                    '<p>' + property.address + '</p>' +
                    '<p><strong>$' + Number(property.price).toLocaleString() + '</strong></p>' +
                    '<p>' + property.bedrooms + ' bd | ' + property.bathrooms + ' ba | ' + property.square_feet + ' sqft</p>' +
                    '<p>Status: ' + property.status + '</p>' +
                    '<p><a href="/admin/properties/property/' + property.id + '/change/" target="_blank">Edit Property</a></p>' +
                    '</div>'
                ))
                .addTo(map);
            markers[property.id] = marker;
            bounds.extend([lng, lat]);
        });

        if (properties.length > 0) {
            map.fitBounds(bounds, { padding: 40, maxZoom: 14 });
        }

        const propertyList = document.getElementById('property-list');
        properties.forEach(function (property) {
            const propertyItem = document.createElement('div');
            propertyItem.className = 'property-item';
            propertyItem.id = `property-${property.id}`;
            propertyItem.innerHTML = `
                <h4>${property.title}</h4>
                <p>${property.address}</p>
                <p><strong>$${Number(property.price).toLocaleString()}</strong></p>
                <p>${property.bedrooms} bd | ${property.bathrooms} ba | ${property.square_feet} sqft</p>
            `;
            propertyItem.addEventListener('click', function () {
                const marker = markers[property.id];
                if (marker) {
                    const ll = marker.getLngLat();
                    map.flyTo({ center: ll, zoom: 14 });
                    marker.togglePopup();
                    highlightProperty(property.id);
                }
            });
            propertyList.appendChild(propertyItem);
        });
    };

    function highlightProperty(propertyId) {
        document.querySelectorAll('.property-item').forEach(function (item) {
            item.classList.remove('active');
        });
        const selectedProperty = document.getElementById(`property-${propertyId}`);
        if (selectedProperty) {
            selectedProperty.classList.add('active');
            selectedProperty.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
</script>
{% endblock %}